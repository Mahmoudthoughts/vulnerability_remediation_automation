namespace: io.cloudslang.microfocus.oo.flow
flow:
  name: flow_execution
  inputs:
    - username:
        default: admin
        required: false
    - password:
        default: Automation.123
        required: false
        sensitive: true
    - server:
        default: som2.hpeswlab.net
        required: false
    - port:
        default: '8443'
        required: false
    - protocol:
        default: https
        required: false
    - flow_input_json:
        required: false
  workflow:
    - base64_encoder:
        do:
          io.cloudslang.base.utils.base64_encoder:
            - data: "${username +':'+ password}"
        publish:
          - authorization: '${result}'
        navigate:
          - SUCCESS: get_oo_version
          - FAILURE: on_failure
    - execute_workflow:
        do:
          io.cloudslang.base.http.http_client_post:
            - url: 'https://som2.hpeswlab.net:8443/oo/rest/v1/executions'
            - auth_type: anonymous
            - username: '${username}'
            - password:
                value: '${password}'
                sensitive: true
            - trust_all_roots: 'true'
            - headers: "${'X-CSRF-TOKEN: '  + token}"
            - body: '${flow_input_json}'
            - content_type: application/json
        publish:
          - return_result
        navigate:
          - SUCCESS: get_execution_id
          - FAILURE: on_failure
    - get_oo_version:
        do:
          io.cloudslang.base.http.http_client_get:
            - url: 'https://som2.hpeswlab.net:8443/oo/rest/version'
            - trust_all_roots: 'true'
            - headers: "${'Authorization: Basic ' + authorization}"
            - content_type: application/json
        publish:
          - output_0: '${return_result}'
          - response_headers: "${response_headers.replace('\\r', ' ')}"
        navigate:
          - SUCCESS: get_token
          - FAILURE: on_failure
    - get_token:
        do:
          io.cloudslang.base.http.get_header_value:
            - response_headers: '${response_headers}'
            - header_name: X-CSRF-TOKEN
        publish:
          - token: '${result}'
        navigate:
          - SUCCESS: execute_workflow
          - FAILURE: on_failure
    - get_execution_id:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${return_result}'
            - json_path: executionId
        publish:
          - execution_id: '${return_result}'
        navigate:
          - SUCCESS: get_flow_execution_summary
          - FAILURE: on_failure
    - get_flow_execution_summary:
        do:
          io.cloudslang.base.http.http_client_get:
            - url: "${'https://som2.hpeswlab.net:8443/oo/rest/v1/executions/'+execution_id+'/summary'}"
            - auth_type: anonymous
            - trust_all_roots: 'true'
            - headers: "${'X-CSRF-TOKEN: '  + token}"
            - content_type: application/json
        publish:
          - return_result: "${return_result.replace('[','').replace(']', '')}"
        navigate:
          - SUCCESS: get_running_status
          - FAILURE: on_failure
    - get_running_status:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${return_result}'
            - json_path: status
        publish:
          - status: '${return_result}'
        navigate:
          - SUCCESS: string_equals
          - FAILURE: on_failure
    - string_equals:
        do:
          io.cloudslang.base.strings.string_equals:
            - first_string: '${status}'
            - second_string: COMPLETED
        navigate:
          - SUCCESS: get_flow_execution_details
          - FAILURE: get_flow_execution_summary
    - get_flow_execution_details:
        do:
          io.cloudslang.base.http.http_client_get:
            - url: "${'https://som2.hpeswlab.net:8443/oo/rest/v1/executions/'+execution_id+'/execution-log'}"
            - auth_type: anonymous
            - trust_all_roots: 'true'
            - headers: "${'X-CSRF-TOKEN: '  + token}"
            - content_type: application/json
        publish:
          - return_result
        navigate:
          - SUCCESS: get_value_1_1
          - FAILURE: on_failure
    - get_value_1_1:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${return_result}'
            - json_path: flowOutput
        publish:
          - results: '${return_result}'
        navigate:
          - SUCCESS: SUCCESS
          - FAILURE: on_failure
  outputs:
    - results: '${results}'
    - execution_id: '${execution_id}'
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_oo_version:
        x: 400
        'y': 150
      execute_workflow:
        x: 1000
        'y': 150
      get_execution_id:
        x: 1300
        'y': 150
      base64_encoder:
        x: 100
        'y': 150
      get_value_1_1:
        x: 2800
        'y': 150
        navigate:
          2c89587d-9912-43d7-f63d-3d52d734bddb:
            targetId: ded54bb5-a41e-cb61-ce10-09610dd92270
            port: SUCCESS
      string_equals:
        x: 2200
        'y': 150
      get_token:
        x: 700
        'y': 150
      get_flow_execution_details:
        x: 2500
        'y': 150
      get_flow_execution_summary:
        x: 1600
        'y': 150
      get_running_status:
        x: 1869
        'y': 375
    results:
      SUCCESS:
        ded54bb5-a41e-cb61-ce10-09610dd92270:
          x: 3100
          'y': 150
