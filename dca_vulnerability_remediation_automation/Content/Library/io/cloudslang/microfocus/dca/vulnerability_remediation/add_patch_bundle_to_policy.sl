namespace: io.cloudslang.microfocus.dca.vulnerability_remediation
flow:
  name: add_patch_bundle_to_policy
  inputs:
    - policy_name:
        default: RR21334345566_policy
        required: false
    - auth_token:
        required: false
    - patch_bundle_id:
        default: '77'
        required: false
  workflow:
    - get_policy:
        do:
          io.cloudslang.microfocus.dca.policy.get_policy:
            - name: '${policy_name}'
            - auth_token: '${auth_token}'
        publish:
          - policy_id
          - policy_details
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_value
    - get_value:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${policy_details}'
            - json_path: benchmarks
        publish:
          - return_result
        navigate:
          - SUCCESS: add_object_into_json_array
          - FAILURE: on_failure
    - add_object_into_json_array:
        do:
          io.cloudslang.base.json.add_object_into_json_array:
            - json_array: '${return_result}'
            - json_object: "${'{\"id\": \"'+patch_bundle_id+'\"} '}"
            - index: '0'
        publish:
          - return_result
        navigate:
          - SUCCESS: add_json_property_to_object
          - FAILURE: on_failure
    - add_json_property_to_object:
        do:
          io.cloudslang.base.json.add_json_property_to_object:
            - json_object: '${policy_details}'
            - key: benchmarks
            - value: '${return_result}'
        publish:
          - return_result
        navigate:
          - SUCCESS: update_policy
          - FAILURE: on_failure
    - update_policy:
        do:
          io.cloudslang.microfocus.dca.policy.update_policy:
            - auth_token: '${auth_token}'
            - json: '${return_result}'
            - policy_id: '${policy_id}'
        publish:
          - return_result
        navigate:
          - FAILURE: already_exists
          - SUCCESS: SUCCESS
    - already_exists:
        do:
          io.cloudslang.microfocus.dca.handler.already_exists:
            - response: '${return_result}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: SUCCESS
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_policy:
        x: 100
        'y': 250
      get_value:
        x: 400
        'y': 250
      add_object_into_json_array:
        x: 700
        'y': 250
      add_json_property_to_object:
        x: 1000
        'y': 250
      update_policy:
        x: 1300
        'y': 250
        navigate:
          2c7f23d2-782e-3e22-2089-d0ee129ebd52:
            targetId: c1e1cd5b-0d2c-81f0-b7e0-dde6fd99146d
            port: SUCCESS
      already_exists:
        x: 1600
        'y': 125
        navigate:
          c0df3c17-ffa5-22cd-ce74-c11bc1f9c3ee:
            targetId: c1e1cd5b-0d2c-81f0-b7e0-dde6fd99146d
            port: SUCCESS
    results:
      SUCCESS:
        c1e1cd5b-0d2c-81f0-b7e0-dde6fd99146d:
          x: 1600
          'y': 375
