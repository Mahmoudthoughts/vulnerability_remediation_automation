namespace: io.cloudslang.microfocus.dca.vulnerability_remediation.demo
flow:
  name: Qualys_vulnerability_report_automation
  inputs:
    - username: admin
    - password:
        default: Automation.123
        sensitive: true
    - oo_server: som2.hpeswlab.net
    - oo_port: '8443'
    - oo_protocol: https
    - remediation_request_id: RR26090400
    - dca_server:
        default: swdemo10.hpeswlab.net
        required: false
    - dca_port:
        default: '443'
        required: false
    - dca_protocol:
        default: https
        required: false
    - requester_name:
        default: mahmoud
        required: false
    - request_date:
        default: 20SEP2019-0824
        required: false
    - request_name:
        required: false
    - request_description:
        default: '190920191009'
        required: false
    - measure_sla:
        default: '10'
        required: false
    - remediate_sla:
        default: '7'
        required: false
    - remdiation_action:
        default: none
        required: false
    - remediation_reboot:
        default: none
        required: false
    - idm_host:
        default: "${get_sp('dca.host')}"
        required: false
    - idm_port:
        default: "${get_sp('idm.port')}"
        required: false
    - idm_protocol:
        default: "${get_sp('idm.protocol')}"
        required: false
    - idm_username:
        default: "${get_sp('idm.username')}"
        required: false
    - idm_password:
        default: "${get_sp('idm.password')}"
        required: false
    - report:
        required: false
    - excelFileName:
        default: "C:\\qualys\\Request_10082_results.xlsx"
        required: false
  workflow:
    - get_authentication_token_1:
        do:
          io.cloudslang.microfocus.dca.authentication.get_authentication_token:
            - idm_host: swdemo10.hpeswlab.net
            - idm_username: transport_admin
            - idm_password:
                value: WhTySQ4TDj
                sensitive: true
            - dca_username: dcaadmin
            - dca_password:
                value: Automation.123
                sensitive: true
            - trust_all_roots: 'true'
        publish:
          - output_0: '${return_code}'
          - output_1: '${return_result}'
          - auth_token
        navigate:
          - SUCCESS: create_or_get_policy
          - FAILURE: on_failure
    - get_valid_rows:
        do:
          io.cloudslang.microfocus.oo.sample.run_flow:
            - flowUuid: 5a1ae0e4-102e-4981-8c76-94b8ae6944ec
            - inputs: "${'excelFileName:'+excelFileName+'|worksheetName:sample|hasHeader:yes|firstRowIndex:0|columnIndextoQuery:0|operator:!=|value:'}"
            - username: '${username}'
            - password:
                value: '${password}'
                sensitive: true
            - oo_server: '${oo_server}'
            - port: '${oo_port}'
            - protocol: '${oo_protocol}'
        publish:
          - results
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_value
    - get_value:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${results}'
            - json_path: valid_rows
        publish:
          - rows: '${return_result}'
        navigate:
          - SUCCESS: get_vulnerability_add_patches
          - FAILURE: on_failure
    - get_vulnerability_add_patches:
        loop:
          for: row in rows
          do:
            io.cloudslang.microfocus.dca.vulnerability_remediation.get_vulnerability_add_patches:
              - auth_token: '${auth_token}'
              - column_delimiter: iii
              - row: '${row}'
              - patch_bundle_id: '${patch_bundle_id}'
              - resource_group_id: '${resource_group_id}'
              - report_in: '${report}'
              - resource_group_name: "${remediation_request_id+'_resource_group'}"
          break:
            - FAILURE
        navigate:
          - FAILURE: on_failure
          - SUCCESS: policy_scan_for_resource_group
    - resource_group_policy_subscription:
        do:
          io.cloudslang.microfocus.dca.resource_group.resource_group_policy_subscription:
            - auth_token: '${auth_token}'
            - policy_id: '${policy_id}'
            - resource_group_id: '${resource_group_id}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_valid_rows
    - add_patch_bundle_to_policy:
        do:
          io.cloudslang.microfocus.dca.vulnerability_remediation.add_patch_bundle_to_policy:
            - policy_name: "${remediation_request_id+'_policy'}"
            - auth_token: '${auth_token}'
            - patch_bundle_id: '${patch_bundle_id}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: create_or_get_resource_group
    - policy_scan_for_resource_group:
        do:
          io.cloudslang.microfocus.dca.vulnerability_remediation.policy_scan_for_resource_group:
            - policy_id: '${policy_id}'
            - auth_token: '${auth_token}'
            - resource_group_name: "${remediation_request_id+'_resource_group'}"
            - basic_json: '{    "jobType": {        "name": "POLICY_REMEDIATE"    },    "targets": [],    "properties": [],    "targetsQuery": "",    "schedule": {        "type": "NOW"    }}'
        publish:
          - output_0: output_0
        navigate:
          - SUCCESS: SUCCESS
          - FAILURE: on_failure
    - create_or_get_patch_bundle:
        do:
          io.cloudslang.microfocus.dca.vulnerability_remediation.subflows.create_or_get_patch_bundle:
            - name: "${remediation_request_id+'_patch_bundle'}"
            - description: '${request_description}'
            - auth_token: '${auth_token}'
        publish:
          - patch_bundle_id
        navigate:
          - SUCCESS: add_patch_bundle_to_policy
          - FAILURE: on_failure
    - create_or_get_resource_group:
        do:
          io.cloudslang.microfocus.dca.vulnerability_remediation.subflows.create_or_get_resource_group:
            - auth_token: '${auth_token}'
            - name: "${remediation_request_id+'_resource_group'}"
            - description: '${request_description}'
        publish:
          - resource_group_id
        navigate:
          - SUCCESS: resource_group_policy_subscription
          - FAILURE: on_failure
    - create_or_get_policy:
        do:
          io.cloudslang.microfocus.dca.vulnerability_remediation.subflows.create_or_get_policy:
            - auth_token: '${auth_token}'
            - name: "${remediation_request_id+'_policy'}"
            - description: '${request_description}'
            - measure_sla: '${measure_sla}'
            - remediate_sla: '${remediate_sla}'
            - remdiation_action: '${remdiation_action}'
            - remediation_reboot: '${remediation_reboot}'
        publish:
          - policy_id
        navigate:
          - FAILURE: on_failure
          - SUCCESS: create_or_get_patch_bundle
  outputs:
    - flow_output_0
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_valid_rows:
        x: 97
        'y': 383
      get_value:
        x: 396
        'y': 525
      get_vulnerability_add_patches:
        x: 698
        'y': 524
      get_authentication_token_1:
        x: 100
        'y': 150
      add_patch_bundle_to_policy:
        x: 1000
        'y': 151
      create_or_get_resource_group:
        x: 1300
        'y': 150
      create_or_get_policy:
        x: 400
        'y': 150
      resource_group_policy_subscription:
        x: 1600
        'y': 150
        navigate:
          5a914f2c-07a5-8a31-31dd-d37464292964:
            vertices:
              - x: 1566
                'y': 418
            targetId: get_valid_rows
            port: SUCCESS
      policy_scan_for_resource_group:
        x: 999
        'y': 530
        navigate:
          ebff0fa1-53c0-d9a5-b986-d155fdbe8bab:
            targetId: 3a7e0c3f-5e75-1e64-7e7d-bc7db98c66a1
            port: SUCCESS
      create_or_get_patch_bundle:
        x: 700
        'y': 150
    results:
      SUCCESS:
        3a7e0c3f-5e75-1e64-7e7d-bc7db98c66a1:
          x: 1294
          'y': 536
