namespace: io.cloudslang.microfocus.dca.vulnerability_remediation
flow:
  name: get_vulnerability_add_patches
  inputs:
    - username: admin
    - password:
        default: Automation.123
        sensitive: true
    - oo_server: som2.hpeswlab.net
    - port: '8443'
    - protocol: https
    - auth_token
    - dca_server: "${get_sp('dca.host')}"
    - dca_port: "${get_sp('dca.port')}"
    - dca_protocol: "${get_sp('dca.protocol')}"
    - column_delimiter
    - row
    - patch_bundle_id
  workflow:
    - get_server_vulnerabilities:
        do:
          io.cloudslang.microfocus.oo.sample.run_flow:
            - flowUuid: 2ec5f196-4c98-4100-a2af-fb22dae4c9ed
            - inputs: "${'rowIndex:'+row+'|columnIndex:1,26,27|excelFileName:C:\\qualys\\sample.xlsx|worksheetName:sample|hasHeader:yes|firstRowIndex:0|rowDelimiter:|columnDelimiter:'+column_delimiter}"
            - username: '${username}'
            - password:
                value: '${password}'
                sensitive: true
            - oo_server: '${oo_server}'
            - port: '${port}'
            - protocol: '${protocol}'
        publish:
          - results
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_value
    - get_cves:
        do:
          io.cloudslang.base.lists.get_by_index:
            - list: '${csv}'
            - delimiter: '${column_delimiter}'
            - index: '1'
        publish:
          - cves: '${return_result.replace(" ",",")}'
        navigate:
          - SUCCESS: add_patchs_to_patch_bundle
          - FAILURE: on_failure
    - get_value:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${results}'
            - json_path: values
        publish:
          - csv: '${return_result}'
        navigate:
          - SUCCESS: get_cves
          - FAILURE: on_failure
    - add_patchs_to_patch_bundle:
        loop:
          for: cve in cves
          do:
            io.cloudslang.microfocus.dca.patch_bundle.add_patchs_to_patch_bundle:
              - patch_bundle_id: '${patch_bundle_id}'
              - cves_title: '${cve}'
              - auth_token: '${auth_token}'
              - dca_server: '${dca_server}'
              - dca_port: '${dca_port}'
          break:
            - FAILURE
        navigate:
          - FAILURE: on_failure
          - SUCCESS: SUCCESS
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_server_vulnerabilities:
        x: 100
        'y': 150
      get_cves:
        x: 700
        'y': 150
      get_value:
        x: 400
        'y': 150
      add_patchs_to_patch_bundle:
        x: 1000
        'y': 150
        navigate:
          bc165985-72f6-d039-4581-24a97c0661bc:
            targetId: 352a94dc-5794-ec52-2fa4-a50f990e84b8
            port: SUCCESS
    results:
      SUCCESS:
        352a94dc-5794-ec52-2fa4-a50f990e84b8:
          x: 1300
          'y': 150
