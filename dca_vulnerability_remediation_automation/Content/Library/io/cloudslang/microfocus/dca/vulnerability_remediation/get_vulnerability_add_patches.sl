namespace: io.cloudslang.microfocus.dca.vulnerability_remediation
flow:
  name: get_vulnerability_add_patches
  inputs:
    - username: admin
    - password:
        default: Automation.123
        sensitive: true
    - oo_server: som2.hpeswlab.net
    - port: '8443'
    - protocol: https
    - auth_token
    - dca_server: "${get_sp('dca.host')}"
    - dca_port: "${get_sp('dca.port')}"
    - dca_protocol: "${get_sp('dca.protocol')}"
    - column_delimiter
    - row
    - patch_bundle_id
    - resource_group_id
    - report_in:
        required: false
    - resource_group_name
  workflow:
    - get_server_vulnerabilities:
        do:
          io.cloudslang.microfocus.oo.sample.run_flow:
            - flowUuid: 2ec5f196-4c98-4100-a2af-fb22dae4c9ed
            - inputs: "${'rowIndex:'+row+'|columnIndex:1,26,27|excelFileName:C:\\qualys\\sample.xlsx|worksheetName:sample|hasHeader:yes|firstRowIndex:0|rowDelimiter:|columnDelimiter:'+column_delimiter}"
            - username: '${username}'
            - password:
                value: '${password}'
                sensitive: true
            - oo_server: '${oo_server}'
            - port: '${port}'
            - protocol: '${protocol}'
        publish:
          - results
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_value
    - get_cves:
        do:
          io.cloudslang.base.lists.get_by_index:
            - list: '${csv}'
            - delimiter: '${column_delimiter}'
            - index: '1'
        publish:
          - cves: '${return_result.replace(" ",",")}'
        navigate:
          - SUCCESS: add_patchs_to_patch_bundle
          - FAILURE: on_failure
    - get_value:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${results}'
            - json_path: values
        publish:
          - csv: '${return_result}'
        navigate:
          - SUCCESS: get_server_name
          - FAILURE: on_failure
    - add_patchs_to_patch_bundle:
        loop:
          for: cve in cves
          do:
            io.cloudslang.microfocus.dca.patch_bundle.add_patchs_to_patch_bundle:
              - patch_bundle_id: '${patch_bundle_id}'
              - cves_title: '${cve}'
              - auth_token: '${auth_token}'
              - dca_server: '${dca_server}'
              - dca_port: '${dca_port}'
              - report_in: '${report_in}'
              - report: '${report_in}'
              - server_name: '${server_name}'
              - patch_bundle_name: '${resource_group_name}'
          break:
            - FAILURE
          publish:
            - report_in: '${report_out}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: SUCCESS
    - get_server_name:
        do:
          io.cloudslang.base.lists.get_by_index:
            - list: '${csv}'
            - delimiter: '${column_delimiter}'
            - index: '0'
        publish:
          - server_name: '${return_result.replace(" ",",")}'
        navigate:
          - SUCCESS: get_resource_id
          - FAILURE: on_failure
    - get_resource_id:
        do:
          io.cloudslang.microfocus.dca.resource.get_resource_id:
            - name: '${server_name}'
            - auth_token: '${auth_token}'
        publish:
          - resource_id
        navigate:
          - FAILURE: on_failure
          - SUCCESS: add_resource_to_resource_group
    - add_resource_to_resource_group:
        do:
          io.cloudslang.microfocus.dca.resource.add_resource_to_resource_group:
            - auth_token: '${auth_token}'
            - resource_id: '${resource_id}'
            - resource_group_id: '${resource_group_id}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: append_new_line
    - append_new_line:
        do:
          io.cloudslang.base-addons.strings.append_new_line:
            - origin_string: '${report_in}'
            - text: "${server_name+' successfully added to resource group '+resource_group_name}"
        publish:
          - report_in: '${new_string}'
        navigate:
          - SUCCESS: get_cves
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_server_vulnerabilities:
        x: 100
        'y': 150
      get_cves:
        x: 1600
        'y': 150
      get_value:
        x: 400
        'y': 150
      add_patchs_to_patch_bundle:
        x: 1900
        'y': 150
        navigate:
          f29e476c-4d3d-6885-df43-54edc69d64b2:
            targetId: 8ac3bc6f-823b-8b1c-1a01-4a8256178c6a
            port: SUCCESS
      get_server_name:
        x: 700
        'y': 150
      get_resource_id:
        x: 1000
        'y': 150
      add_resource_to_resource_group:
        x: 1300
        'y': 150
      append_new_line:
        x: 1436
        'y': 344
    results:
      SUCCESS:
        8ac3bc6f-823b-8b1c-1a01-4a8256178c6a:
          x: 2200
          'y': 150
