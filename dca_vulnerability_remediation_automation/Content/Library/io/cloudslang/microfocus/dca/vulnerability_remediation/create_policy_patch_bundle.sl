namespace: io.cloudslang.microfocus.dca.vulnerability_remediation
flow:
  name: create_policy_patch_bundle
  inputs:
    - username: admin
    - password:
        default: Automation.123
        sensitive: true
    - oo_server: som2.hpeswlab.net
    - oo_port: '8443'
    - oo_protocol: https
    - remediation_request_id: RR21334345566
    - dca_server: swdemo10.hpeswlab.net
    - dca_port: '443'
    - dca_protocol: https
    - requester_name: mahmoud
    - request_date: 20SEP2019-0824
    - request_name:
        required: false
    - request_description:
        default: '190920191009'
        required: false
    - measure_sla: '10'
    - remediate_sla: '7'
    - remdiation_action: none
    - remediation_reboot: none
    - idm_host: "${get_sp('dca.host')}"
    - idm_port: "${get_sp('idm.port')}"
    - idm_protocol: "${get_sp('idm.protocol')}"
    - idm_username: "${get_sp('idm.username')}"
    - idm_password: "${get_sp('idm.password')}"
  workflow:
    - get_authentication_token_1:
        do:
          io.cloudslang.microfocus.dca.authentication.get_authentication_token:
            - idm_host: swdemo10.hpeswlab.net
            - idm_username: transport_admin
            - idm_password:
                value: WhTySQ4TDj
                sensitive: true
            - dca_username: dcaadmin
            - dca_password:
                value: Automation.123
                sensitive: true
            - trust_all_roots: 'true'
        publish:
          - output_0: '${return_code}'
          - output_1: '${return_result}'
          - auth_token
        navigate:
          - SUCCESS: create_patch_bundle
          - FAILURE: on_failure
    - get_valid_rows:
        do:
          io.cloudslang.microfocus.oo.sample.run_flow:
            - flowUuid: 5a1ae0e4-102e-4981-8c76-94b8ae6944ec
            - inputs: "excelFileName:C:\\qualys\\sample.xlsx|worksheetName:sample|hasHeader:yes|firstRowIndex:0|columnIndextoQuery:0|operator:!=|value:"
            - username: '${username}'
            - password:
                value: '${password}'
                sensitive: true
            - oo_server: '${oo_server}'
            - port: '${oo_port}'
            - protocol: '${oo_protocol}'
        publish:
          - results
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_value
    - get_value:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${results}'
            - json_path: valid_rows
        publish:
          - rows: '${return_result}'
        navigate:
          - SUCCESS: create_resource_group
          - FAILURE: on_failure
    - get_vulnerability_add_patches:
        loop:
          for: row in rows
          do:
            io.cloudslang.microfocus.dca.vulnerability_remediation.get_vulnerability_add_patches:
              - auth_token: '${auth_token}'
              - column_delimiter: iii
              - row: '${row}'
              - patch_bundle_id: '${patch_bundle_id}'
          break:
            - FAILURE
        navigate:
          - FAILURE: on_failure
          - SUCCESS: create_policy
    - create_patch_bundle:
        do:
          io.cloudslang.microfocus.dca.patch_bundle.create_patch_bundle:
            - name: "${remediation_request_id+'_patch_bundle'}"
            - description: '${request_description}'
            - auth_token: '${auth_token}'
        publish:
          - patch_bundle_id
          - return_result
        navigate:
          - FAILURE: response_handler
          - SUCCESS: get_valid_rows
    - create_resource_group:
        do:
          io.cloudslang.microfocus.dca.resource_group.create_resource_group:
            - auth_token: '${auth_token}'
            - name: "${remediation_request_id+'_resource_group'}"
            - description: '${request_description}'
        publish:
          - resource_group_id
          - output_0: output_0
        navigate:
          - FAILURE: response_handler_1
          - SUCCESS: get_vulnerability_add_patches
    - create_policy:
        do:
          io.cloudslang.microfocus.dca.policy.create_policy:
            - auth_token: '${auth_token}'
            - name: "${remediation_request_id+'_policy'}"
        publish:
          - policy_id
          - return_result
        navigate:
          - FAILURE: response_handler_2
          - SUCCESS: resource_group_policy_subscription
    - resource_group_policy_subscription:
        do:
          io.cloudslang.microfocus.dca.resource_group.resource_group_policy_subscription:
            - auth_token: '${auth_token}'
            - policy_id: '${policy_id}'
            - resource_group_id: '${resource_group_id}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: SUCCESS
    - response_handler:
        do:
          io.cloudslang.microfocus.dca.handler.response_handler:
            - response: '${return_result}'
        publish:
          - output_0: output_0
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_patch_bundle
    - get_patch_bundle:
        do:
          io.cloudslang.microfocus.dca.patch_bundle.get_patch_bundle:
            - patch_bundle_name: "${remediation_request_id+'_patch_bundle'}"
            - auth_token: '${auth_token}'
        publish:
          - patch_bundle_id
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_valid_rows
    - get_resource_group:
        do:
          io.cloudslang.microfocus.dca.resource_group.get_resource_group:
            - resource_group_name: "${remediation_request_id+'_resource_group'}"
            - auth_token: '${auth_token}'
        publish:
          - resource_group_id
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_vulnerability_add_patches
    - response_handler_1:
        do:
          io.cloudslang.microfocus.dca.handler.response_handler:
            - response: '${return_result}'
        publish:
          - output_0: output_0
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_resource_group
    - response_handler_2:
        do:
          io.cloudslang.microfocus.dca.handler.response_handler:
            - response: '${return_result}'
        publish: []
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_policy
    - get_policy:
        do:
          io.cloudslang.microfocus.dca.policy.get_policy:
            - name: "${remediation_request_id+'_policy'}"
            - auth_token: '${auth_token}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: resource_group_policy_subscription
  outputs:
    - flow_output_0
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_patch_bundle:
        x: 1000
        'y': 125
      get_valid_rows:
        x: 700
        'y': 375
      get_value:
        x: 1000
        'y': 375
      response_handler:
        x: 700
        'y': 125
      get_vulnerability_add_patches:
        x: 1600
        'y': 375
      get_authentication_token_1:
        x: 100
        'y': 250
      create_resource_group:
        x: 1300
        'y': 250
      create_policy:
        x: 1901
        'y': 375
      get_resource_group:
        x: 1900
        'y': 125
      resource_group_policy_subscription:
        x: 2200
        'y': 250
        navigate:
          0a4a12c8-a195-5730-e33c-f50e5eb7c8e4:
            targetId: a21a57e7-d523-7a4b-e11a-e1e62000c6a1
            port: SUCCESS
      get_policy:
        x: 2117
        'y': 514
      create_patch_bundle:
        x: 400
        'y': 250
      response_handler_1:
        x: 1600
        'y': 125
      response_handler_2:
        x: 1966
        'y': 505
    results:
      SUCCESS:
        a21a57e7-d523-7a4b-e11a-e1e62000c6a1:
          x: 2500
          'y': 250
