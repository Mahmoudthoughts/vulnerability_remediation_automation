namespace: io.cloudslang.microfocus.dca.vulnerability_remediation
flow:
  name: create_policy_patch_bundle
  inputs:
    - username: admin
    - password:
        default: Automation.123
        sensitive: true
    - oo_server: som2.hpeswlab.net
    - oo_port: '8443'
    - oo_protocol: https
    - remediation_request_id: RR21546
    - dca_server: swdemo10.hpeswlab.net
    - dca_port: '443'
    - dca_protocol: https
    - requester_name: mahmoud
    - request_date: 20SEP2019-0824
    - request_name:
        required: false
    - request_description:
        required: false
    - measure_sla: '10'
    - remediate_sla: '7'
    - remdiation_action: none
    - remediation_reboot: none
    - idm_host: "${get_sp('idm.idm_host')}"
    - idm_port
    - idm_protocol
    - idm_username
    - idm_password
  workflow:
    - get_valid_rows:
        do:
          io.cloudslang.microfocus.oo.sample.run_flow:
            - flowUuid: 5a1ae0e4-102e-4981-8c76-94b8ae6944ec
            - inputs: "excelFileName:C:\\qualys\\sample.xlsx|worksheetName:sample|hasHeader:yes|firstRowIndex:0|columnIndextoQuery:0|operator:!=|value:"
            - username: '${username}'
            - password:
                value: '${password}'
                sensitive: true
            - oo_server: '${oo_server}'
            - port: '${port}'
            - protocol: '${protocol}'
        publish:
          - results
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_value
    - get_value:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${results}'
            - json_path: valid_rows
        publish:
          - rows: '${return_result}'
        navigate:
          - SUCCESS: get_vulnerability_add_patches
          - FAILURE: on_failure
    - get_authentication_token_1:
        do:
          io.cloudslang.microfocus.dca.authentication.get_authentication_token:
            - idm_host: swdemo10.hpeswlab.net
            - idm_username: transport_admin
            - idm_password:
                value: WhTySQ4TDj
                sensitive: true
            - dca_username: dcaadmin
            - dca_password:
                value: Automation.123
                sensitive: true
            - trust_all_roots: 'true'
        publish:
          - output_0: '${return_code}'
          - output_1: '${return_result}'
          - auth_token
        navigate:
          - SUCCESS: create_patch_bundle
          - FAILURE: on_failure
    - get_vulnerability_add_patches:
        loop:
          for: row in rows
          do:
            io.cloudslang.microfocus.dca.vulnerability_remediation.get_vulnerability_add_patches:
              - auth_token: '${auth_token}'
              - row: '${row}'
              - patch_bundle_id: '${patch_bundle_id}'
          break:
            - FAILURE
        navigate:
          - FAILURE: on_failure
          - SUCCESS: SUCCESS
    - create_patch_bundle:
        do:
          io.cloudslang.microfocus.dca.patch_bundle.create_patch_bundle:
            - name: "${remediation_request_id+'_patch_bundle'}"
            - description: '${request_description}'
            - auth_token: '${auth_token}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_valid_rows
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_authentication_token_1:
        x: 50
        'y': 30
      create_patch_bundle:
        x: 120
        'y': 216
      get_valid_rows:
        x: 196
        'y': 416
      get_value:
        x: 400
        'y': 150
      get_vulnerability_add_patches:
        x: 700
        'y': 150
        navigate:
          689240e9-1eeb-f9fd-89c2-89cfccb38ca1:
            targetId: d120f345-c6da-29f0-9060-00fe2a1070bf
            port: SUCCESS
    results:
      SUCCESS:
        d120f345-c6da-29f0-9060-00fe2a1070bf:
          x: 1000
          'y': 150
