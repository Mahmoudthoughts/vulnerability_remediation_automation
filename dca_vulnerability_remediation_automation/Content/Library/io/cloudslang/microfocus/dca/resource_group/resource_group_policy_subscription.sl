namespace: io.cloudslang.microfocus.dca.resource_group
flow:
  name: resource_group_policy_subscription
  inputs:
    - auth_token
    - dca_server: "${get_sp('dca.host')}"
    - dca_port: "${get_sp('dca.port')}"
    - dca_protocol: "${get_sp('dca.protocol')}"
    - policy_id
    - resource_group_id
  workflow:
    - create_policy_subscription:
        do:
          io.cloudslang.base.http.http_client_post:
            - url: "${dca_protocol+'://'+dca_server+':'+dca_port+'/urest/v1/policy/'+policy_id+'/subscription'}"
            - auth_type: basic
            - trust_all_roots: 'true'
            - headers: "${'X-Auth-Token:' + auth_token}"
            - body: "${'{\"target\":{\"id\":\"'+resource_group_id+'\",\"type\":\"RESOURCE_GROUP\"}}'}"
            - content_type: application/json
        publish:
          - reponse: '${return_result}'
          - item_id: '${return_result}'
        navigate:
          - SUCCESS: get_item_id
          - FAILURE: already_exists
    - get_item_id:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${reponse}'
            - json_path: id
        publish:
          - item_id: '${return_result}'
        navigate:
          - SUCCESS: SUCCESS
          - FAILURE: on_failure
    - already_exists:
        do:
          io.cloudslang.microfocus.dca.handler.already_exists:
            - response: '${reponse}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: SUCCESS
  outputs:
    - return_results: '${item_id}'
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      create_policy_subscription:
        x: 100
        'y': 250
      get_item_id:
        x: 400
        'y': 125
        navigate:
          3b518ffc-dfe5-8e07-3bfa-7675225e27b1:
            targetId: 8657f6a8-c97f-66d4-bc96-9925b3a67cbf
            port: SUCCESS
      already_exists:
        x: 400
        'y': 375
        navigate:
          0144ef4c-ff60-52d0-ef86-e4de31a95452:
            targetId: 8657f6a8-c97f-66d4-bc96-9925b3a67cbf
            port: SUCCESS
    results:
      SUCCESS:
        8657f6a8-c97f-66d4-bc96-9925b3a67cbf:
          x: 700
          'y': 250
