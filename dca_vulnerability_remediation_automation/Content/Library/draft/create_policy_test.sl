namespace: draft
flow:
  name: create_policy_test
  inputs:
    - username: admin
    - password:
        default: Automation.123
        sensitive: true
    - oo_server: som2.hpeswlab.net
    - oo_port: '8443'
    - oo_protocol: https
    - remediation_request_id: RR213343
    - dca_server: "${get_sp('dca.host')}"
    - dca_port: "${get_sp('dca.port')}"
    - dca_protocol: "${get_sp('dca.protocol')}"
    - requester_name: mahmoud
    - request_date: 20SEP2019-0824
    - request_name:
        required: false
    - request_description:
        default: '190920191009'
        required: false
    - measure_sla: '10'
    - remediate_sla: '7'
    - remdiation_action:
        required: false
    - remediation_reboot: RebootAfterRemediation
    - idm_host: "${get_sp('idm.host')}"
    - idm_port: "${get_sp('idm.port')}"
    - idm_protocol: "${get_sp('idm.protocol')}"
    - idm_username: "${get_sp('idm.username')}"
    - idm_password: "${get_sp('idm.password')}"
    - dca_username: "${get_sp('dca.username')}"
    - dca_password:
        default: "${get_sp('dca.password')}"
        sensitive: true
  workflow:
    - get_authentication_token_1:
        do:
          io.cloudslang.microfocus.dca.authentication.get_authentication_token:
            - idm_host: swdemo10.hpeswlab.net
            - idm_username: transport_admin
            - idm_password:
                value: WhTySQ4TDj
                sensitive: true
            - dca_username: dcaadmin
            - dca_password:
                value: Automation.123
                sensitive: true
            - trust_all_roots: 'true'
        publish:
          - output_0: '${return_code}'
          - output_1: '${return_result}'
          - auth_token
        navigate:
          - SUCCESS: create_policy
          - FAILURE: on_failure
    - create_policy:
        do:
          io.cloudslang.base.http.http_client_post:
            - url: "${''+dca_protocol+'://'+dca_server+':'+dca_port+'/urest/v1/policy'}"
            - auth_type: basic
            - trust_all_roots: 'true'
            - headers: "${'X-Auth-Token:' + auth_token}"
            - body: "${'{\"name\":\"'+remediation_request_id+'_policy\",\"description\":\"'+request_description+'\",\"measurementSLO\":{\"amount\":'+measure_sla+',\"unit\":\"DAYS\"},\"remediationSLO\":{\"amount\":'+remediate_sla+',\"unit\":\"DAYS\"},\"remediationRebootOption\":\"'+remediation_reboot+'\"}'}"
            - content_type: application/json
        publish:
          - reponse: '${return_result}'
        navigate:
          - SUCCESS: get_item_id
          - FAILURE: response_handler
    - get_item_id:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${reponse}'
            - json_path: id
        publish:
          - item_id: '${return_result}'
        navigate:
          - SUCCESS: SUCCESS
          - FAILURE: on_failure
    - response_handler:
        do:
          io.cloudslang.microfocus.dca.handler.response_handler:
            - response: '${reponse}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_policy
    - get_policy:
        do:
          io.cloudslang.base.http.http_client_get:
            - url: "${''+dca_protocol+'://'+dca_server+':'+dca_port+'/urest/v1/policy'}"
            - auth_type: basic
            - trust_all_roots: 'true'
            - keystore_password:
                value: null
                sensitive: true
            - headers: "${'X-Auth-Token:' + auth_token}"
            - query_params: "${\"query=name EQ '\"+remediation_request_id+\"_policy'\"}"
            - content_type: application/json
        publish:
          - return_result
        navigate:
          - SUCCESS: get_value
          - FAILURE: on_failure
    - get_value:
        do:
          io.cloudslang.base.json.get_value:
            - json_input: '${return_result}'
            - json_path: 'members,0,id'
        publish:
          - item_id: '${return_result}'
        navigate:
          - SUCCESS: SUCCESS
          - FAILURE: on_failure
  outputs:
    - policy_id: '${item_id}'
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_authentication_token_1:
        x: 100
        'y': 250
      create_policy:
        x: 400
        'y': 250
      get_item_id:
        x: 700
        'y': 125
        navigate:
          471642ff-9d03-0afc-1d49-c9923a65173d:
            targetId: 74aa3f59-8794-a255-142a-9c576eff7316
            port: SUCCESS
      response_handler:
        x: 700
        'y': 375
      get_policy:
        x: 1000
        'y': 250
      get_value:
        x: 1300
        'y': 250
        navigate:
          d536c2dc-719a-bbc9-f305-1fb071041d86:
            targetId: 74aa3f59-8794-a255-142a-9c576eff7316
            port: SUCCESS
    results:
      SUCCESS:
        74aa3f59-8794-a255-142a-9c576eff7316:
          x: 1600
          'y': 250
