########################################################################################################################
#!!
#! @input username: integration user account
#! @input password: integration user password
#! @input tenant_id: this is not needed in this flow
#!!#
########################################################################################################################
namespace: io.cloudslang.microfocus.smax.commons
flow:
  name: get_sso_token_idm
  inputs:
    - username: mahmoud
    - password: M@hm0ud@123
    - smax_server: swvm151.hpeswlab.net
    - smax_protocol: https
    - smax_port: '443'
    - tenant_id:
        required: false
  workflow:
    - base64_decoder_1:
        do:
          io.cloudslang.base.utils.base64_decoder:
            - data: l0JiaguQ0xO1xw==
        publish:
          - idm_password: '${result}'
        navigate:
          - SUCCESS: get_authentication_token
          - FAILURE: on_failure
    - http_client_post:
        do:
          io.cloudslang.base.http.http_client_post:
            - url: "${smax_protocol+'://'+smax_server+':'+smax_port+'/auth/authentication-endpoint/authenticate/login'}"
            - auth_type: basic
            - trust_all_roots: 'true'
            - body: "${'{ \"Login\":\"'+username+'\", \"Password\": \"'+password+'\" }'}"
            - content_type: application/json
        publish:
          - return_result
        navigate:
          - SUCCESS: SUCCESS
          - FAILURE: on_failure
    - get_authentication_token:
        do:
          io.cloudslang.microfocus.dca.authentication.get_authentication_token:
            - idm_host: '${smax_server}'
            - idm_port: '${smax_port}'
            - idm_username: mahmoud
            - idm_password:
                value: '${password}'
                sensitive: true
            - dca_username: mahmoud
            - dca_password:
                value: M@hm0ud@123
                sensitive: true
        navigate:
          - SUCCESS: http_client_post
          - FAILURE: on_failure
  outputs:
    - token
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      base64_decoder_1:
        x: 100
        'y': 150
      http_client_post:
        x: 700
        'y': 150
        navigate:
          769a402e-5f97-8328-0d13-7efe49c218bd:
            targetId: 6d72672d-1cec-b8ef-ba2c-2d95e9c1e956
            port: SUCCESS
      get_authentication_token:
        x: 400
        'y': 150
    results:
      SUCCESS:
        6d72672d-1cec-b8ef-ba2c-2d95e9c1e956:
          x: 1000
          'y': 150
