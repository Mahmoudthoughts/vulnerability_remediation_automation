########################################################################################################################
#!!
#! @input username: integration user account
#! @input password: integration user password
#!!#
########################################################################################################################
namespace: io.cloudslang.microfocus.smax.samples
flow:
  name: get_attechment_request
  inputs:
    - username: "${get_sp('smax.username')}"
    - password: "${get_sp('smax.password')}"
    - smax_server: "${get_sp('smax.server')}"
    - smax_protocol: "${get_sp('smax.protocol')}"
    - smax_port: "${get_sp('smax.port')}"
    - tenant_id:
        default: '221857555'
        required: true
    - filename: results.xlsx
    - entity_type: Request
    - entity_id: '10082'
  workflow:
    - get_sso_token_by_user:
        do:
          io.cloudslang.microfocus.smax.commons.get_sso_token_by_user:
            - username: '${username}'
            - password: '${password}'
            - smax_server: '${smax_server}'
            - smax_protocol: '${smax_protocol}'
            - smax_port: '${smax_port}'
            - tenant_id: '${tenant_id}'
        publish:
          - token: '${LWSSO_COOKIE_KEY}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_entitiy
    - get_entitiy:
        do:
          io.cloudslang.microfocus.smax.commons.get_entitiy:
            - entity_type: '${entity_type}'
            - entity_id: '${entity_id}'
            - fields: 'Id,Name,Description,UserOptions,RequestAttachments'
            - token: '${token}'
            - tenant_id: '${tenant_id}'
            - smax_server: '${smax_server}'
            - smax_port: '${smax_port}'
            - smax_protocol: '${smax_protocol}'
        publish:
          - entity_details: "${entity_details.replace('\\\\','').replace('\"{\"','{\"').replace('}\"','}')}"
          - output_0: '${entity_details}'
        navigate:
          - FAILURE: on_failure
          - SUCCESS: get_value_using_dots_1
    - get_value_using_dots_1:
        do:
          io.cloudslang.base-addons.json.get_value_using_dots:
            - json_input: '${entity_details}'
            - json_path: 'properties.RequestAttachments.complexTypeProperties[0].properties.id'
        publish:
          - attachment_id: '${return_result}'
        navigate:
          - SUCCESS: http_client_get_file
          - FAILURE: on_failure
    - http_client_get_file:
        do:
          io.cloudslang.base.http.http_client_get_file:
            - url: "${smax_protocol+'://'+smax_server+':'+smax_port+'/rest/'+tenant_id+'/ces/attachment/'+attachment_id}"
            - auth_type: null
            - trust_all_roots: 'true'
            - headers: "${'Cookie:LWSSO_COOKIE_KEY='+token}"
            - content_type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
            - destination_file: "${'C:\\\\qualys\\\\'+entity_type+'_'+entity_id+'_'+filename}"
        publish:
          - destination_file
        navigate:
          - SUCCESS: SUCCESS
          - FAILURE: on_failure
  outputs:
    - destination_file: '${destination_file}'
  results:
    - FAILURE
    - SUCCESS
extensions:
  graph:
    steps:
      get_sso_token_by_user:
        x: 100
        'y': 150
      get_entitiy:
        x: 400
        'y': 150
      get_value_using_dots_1:
        x: 700
        'y': 150
      http_client_get_file:
        x: 1000
        'y': 150
        navigate:
          6abb2c4b-bcc2-08fb-153e-c3db88ecddde:
            targetId: 6c1825f3-f308-93b7-304c-18451fcafa85
            port: SUCCESS
    results:
      SUCCESS:
        6c1825f3-f308-93b7-304c-18451fcafa85:
          x: 1300
          'y': 150
